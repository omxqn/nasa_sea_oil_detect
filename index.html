<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🌊 Sea Guardian — International Waters Dashboard</title>

  <!-- مكتبات خارجية -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f5f7fa; --ink:#0f172a; --muted:#64748b;
      --brand:#0f4c81; --card:#ffffff;
      --ok:#16a34a; --warn:#f59e0b; --alert:#dc2626;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
    }
    body.dark{
      --bg:#0f172a; --ink:#e2e8f0; --muted:#94a3b8;
      --brand:#1e293b; --card:#1e293b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:"Cairo",sans-serif;display:flex;overflow:hidden
    }
    /* الشريط الجانبي */
    aside{
      width:240px;background:var(--brand);color:#fff;
      display:flex;flex-direction:column;box-shadow:var(--shadow)
    }
    aside h2{
      margin:0;padding:20px;font-size:20px;font-weight:800;
      border-bottom:1px solid rgba(255,255,255,.12)
    }
    .nav{padding:8px;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;padding:12px;border-radius:12px;transition:.25s}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.15)}

    /* الهيدر */
    main{flex:1;display:flex;flex-direction:column;overflow:auto;min-width:0}
    header{
      background:var(--card);box-shadow:var(--shadow);
      margin:16px;border-radius:14px;padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between
    }
    .btn,.select{
      border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer
    }
    body.dark .btn,body.dark .select{background:#0b1220;color:#e2e8f0;border-color:#334155}

    section.page{display:none;padding:16px}
    section.page.active{display:block;animation:fadeIn .4s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* كروت المؤشرات */
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;text-align:center}
    .card h3{margin:0;color:var(--muted);font-size:14px}
    .card .value{margin-top:6px;font-size:28px;font-weight:900}

    /* مربع الحالة العامة */
    .state-box {
      margin-top: 12px;padding: 12px 0;border-radius: 10px;
      font-weight: 800;font-size: 18px;text-align: center;
      background: #dcfce7;color: #166534;transition: all .3s ease;
    }
    .state-box.warning {background:#fef9c3;color:#92400e}
    .state-box.alert {background:#fee2e2;color:#b91c1c}

    /* الخريطة */
    .map-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px}
    #map{height:520px;border-radius:12px}
    .legend{font-size:12px;color:var(--muted);padding:6px 2px}

    .controls {text-align:center;margin:10px 0;}
    .controls .btn {margin:5px}

    /* الجدول */
    .table-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
    thead th{background:#f9fafb}
    tr:hover{background:#f3f4f6}
    .status-ok{color:var(--ok);font-weight:800}
    .status-warning{color:var(--warn);font-weight:800}
    .status-alert{color:var(--alert);font-weight:800}

    /* الرسوم البيانية */
    .chart-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    canvas{width:100%!important;height:360px!important;background:#f8fafc;border-radius:12px}

    /* Toast */
    .toast{
      position:fixed;top:18px;right:18px;background:#111827;color:#fff;
      padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;animation:fadeIn .3s ease
    }
  </style>
</head>
<body>
  <!-- الشريط الجانبي -->
  <aside>
    <h2>Sea Guardian</h2>
    <nav class="nav">
      <a href="#" class="active" data-target="page-map"><i class="fa-solid fa-water"></i> الخريطة</a>
      <a href="#" data-target="page-events"><i class="fa-solid fa-table"></i> البيانات</a>
      <a href="#" data-target="page-charts"><i class="fa-solid fa-chart-line"></i> التحليلات</a>
    </nav>
  </aside>

  <!-- المحتوى -->
  <main>
    <header>
      <h1 style="margin:0;font-size:18px">لوحة التحكم — مياه دولية</h1>
      <div>
        <button id="themeToggle" class="btn">🌙 الوضع الليلي</button>
      </div>
    </header>

    <!-- صفحة الخريطة -->
    <section id="page-map" class="page active">
      <div class="stats">
        <div class="card"><h3>العكارة</h3><div class="value" id="avgTurb">--</div></div>
        <div class="card"><h3>pH</h3><div class="value" id="avgPh">--</div></div>
        <div class="card"><h3>EC</h3><div class="value" id="avgEc">--</div></div>
        <div class="card"><h3>الحالة</h3><div id="stateBox" class="state-box ok">OK</div></div>
      </div>

      <div class="map-wrap">
        <div id="map"></div>
        <div class="controls">
          <button class="btn" onclick="simulateForward()">تشغيل التنبؤ للأمام</button>
          <button class="btn" onclick="simulateBackward()">تشغيل الرجوع للخلف</button>
        </div>
        <div class="legend">• العوامات: أخضر=آمن / أصفر=Warning / أحمر=خطر · المسار الأحمر=Forward · الأزرق=Backward · المواقع بالمياه الدولية شرق عُمان</div>
      </div>
    </section>

    <!-- صفحة البيانات -->
    <section id="page-events" class="page">
      <div class="table-wrap">
        <table>
          <thead><tr><th>الوقت</th><th>العوامة</th><th>عكارة</th><th>pH</th><th>EC</th><th>الحالة</th></tr></thead>
        <tbody id="eventsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- صفحة التحليلات -->
    <section id="page-charts" class="page">
      <div class="chart-wrap"><canvas id="seriesChart"></canvas></div>
    </section>
  </main>

  <script>
    // ================= إعدادات عامة =================
    const $ = s => document.querySelector(s);
    const UPDATE_MS = 60000;   // كل دقيقة — للتجربة غيّرها إلى 5000
    const HOURLY_ALERT_MS = 3600000; // مرة كل ساعة — للتجربة غيّرها إلى 30000
    const MAX_EVENTS_ROWS = 200; // حد أقصى لصفوف السجل

    // Toast helper
    function showToast(msg, ms=3500){
      const t=document.createElement('div');
      t.className='toast'; t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),ms);
    }

    // ================= نطاق دولي — إحداثيات تقريبية شرق عُمان =================
    // اخترنا خطوط طول > 60.8 لضمان البعد عن المياه الإقليمية (12nm)
    const INTERNATIONAL_DOMAIN = { latMin:22.7, latMax:23.8, lonMin:61.1, lonMax:62.3 };

    function randIn(min,max){ return Math.random()*(max-min)+min; }

    // خمسة عوامات في المياه الدولية
    const BUOYS = [
      { id:"IB-01", lat: randIn(23.1,23.6), lon: randIn(61.3,61.9) },
      { id:"IB-02", lat: randIn(22.9,23.5), lon: randIn(61.8,62.2) },
      { id:"IB-03", lat: randIn(22.8,23.4), lon: randIn(61.4,62.0) },
      { id:"IB-04", lat: randIn(23.2,23.7), lon: randIn(61.2,61.8) },
      { id:"IB-05", lat: randIn(22.9,23.3), lon: randIn(61.7,62.3) },
    ];

    // ================= وظائف محاكاة قراءات الحساسات =================
    function synthReading(prev){
      // نطاقات "منطقية" للمحيط
      // العكارة (NTU): 1–15، pH: 7.8–8.6، EC (PSU تقريبًا): 30–42
      const turb = clampJitter(prev?.turbidity ?? randIn(2,7), 1, 15, 0.8);
      const ph   = clampJitter(prev?.ph        ?? randIn(7.9,8.2), 7.6, 9.3, 0.08);
      const ec   = clampJitter(prev?.ec        ?? randIn(33,37), 28, 44, 1.0);

      const status = (turb>11 || ph>9.0 || ec>41) ? "ALERT"
                    : (turb>8.5 || ph>8.5 || ec>38) ? "WARNING" : "OK";

      return { turbidity:+turb.toFixed(2), ph:+ph.toFixed(2), ec:+ec.toFixed(2), status };
    }

    function clampJitter(val, min, max, jitter){
      let v = val + randIn(-jitter, jitter);
      if(v<min) v = min + Math.random()*(min+1-min);
      if(v>max) v = max - Math.random()*(max-(max-1));
      return v;
    }

    // تحريك بسيط لموقع العوامة (متر/ثانية تقريبية إلى درجات)
    function driftPosition(b){
      // "تيار" و"ريح" اصطناعيان
      const t = Date.now()/1000;
      const u_curr = 0.25*Math.sin(b.lat*2+t/500); // m/s east
      const v_curr = 0.20*Math.cos(b.lon*2+t/600); // m/s north
      const u_wind = 0.05*Math.cos(t/700);
      const v_wind = 0.05*Math.sin(t/700);
      const u = u_curr + 0.02*u_wind;
      const v = v_curr + 0.02*v_wind;
      const dt = UPDATE_MS/1000; // ثانية

      const metersPerDegLat = 111000;
      const dLon = (u*dt) / (metersPerDegLat*Math.cos(b.lat*Math.PI/180));
      const dLat = (v*dt) / metersPerDegLat;

      b.lon += dLon; b.lat += dLat;

      // ابقها داخل النطاق الدولي
      b.lat = Math.max(INTERNATIONAL_DOMAIN.latMin, Math.min(INTERNATIONAL_DOMAIN.latMax, b.lat));
      b.lon = Math.max(INTERNATIONAL_DOMAIN.lonMin, Math.min(INTERNATIONAL_DOMAIN.lonMax, b.lon));
    }

    // ================= الخريطة =================
    const map = L.map('map').setView([23.2,61.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const buoyMarkers = new Map();
    let trajectoryLayer = null;

    function statusColor(s){return s==="ALERT"?"#dc2626":s==="WARNING"?"#f59e0b":"#16a34a";}

    function renderBuoys(readingsMap){
      BUOYS.forEach(b=>{
        const reading = readingsMap.get(b.id);
        const color = statusColor(reading?.status || "OK");
        const marker = buoyMarkers.get(b.id);
        if(!marker){
          const m = L.circleMarker([b.lat,b.lon],{radius:8,color,fillOpacity:.9})
                      .addTo(map).bindPopup(`${b.id}`);
          buoyMarkers.set(b.id,m);
        }else{
          marker.setLatLng([b.lat,b.lon]).setStyle({color});
        }
      });
    }
    function clearTrajectory(){
      if(trajectoryLayer){ map.removeLayer(trajectoryLayer); trajectoryLayer=null; }
    }

    // أمثلة مسارات تجريبية فقط للمعاينة
    const forwardExample = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[61.6,23.2],[61.8,23.3],[62.1,23.35]]}}]};
    const backwardExample = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[61.6,23.2],[61.35,23.1],[61.2,23.0]]}}]};

    function simulateForward(){
      clearTrajectory();
      trajectoryLayer = L.geoJSON(forwardExample,{style:{color:"red",weight:3}}).addTo(map);
      showToast("✅ تم تشغيل التنبؤ للأمام (عرض تجريبي على الواجهة)");
    }
    function simulateBackward(){
      clearTrajectory();
      trajectoryLayer = L.geoJSON(backwardExample,{style:{color:"blue",weight:3}}).addTo(map);
      showToast("✅ تم تشغيل الرجوع للخلف (عرض تجريبي على الواجهة)");
    }

    // ================= الحالة العامة =================
    function updateGlobalState(readings){
      const hasAlert = readings.some(r=>r.status==="ALERT");
      const hasWarn  = readings.some(r=>r.status==="WARNING");
      const box = $('#stateBox');
      const state = hasAlert ? "ALERT" : hasWarn ? "WARNING" : "OK";
      box.textContent = state;
      box.className = "state-box " + (state==="OK"?"ok":state.toLowerCase());
    }

    // ================= الجدول =================
    const eventsBody = $('#eventsBody');
    function appendEventRow(ts, id, r){
      const cls = r.status==="ALERT"?"status-alert":r.status==="WARNING"?"status-warning":"status-ok";
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${ts}</td><td>${id}</td><td>${r.turbidity}</td><td>${r.ph}</td><td>${r.ec}</td><td class="${cls}">${r.status}</td>`;
      eventsBody.prepend(tr); // الأحدث في الأعلى
      while(eventsBody.rows.length>MAX_EVENTS_ROWS){ eventsBody.deleteRow(-1); }
    }

    // ================= الرسوم البيانية =================
    const seriesData={labels:[],datasets:[
      {label:'Turbidity (avg)',data:[],borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.2)',fill:true,tension:.3},
      {label:'pH (avg)',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.2)',fill:true,tension:.3},
      {label:'EC (avg)',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.2)',fill:true,tension:.3},
    ]};
    const seriesChart=new Chart($('#seriesChart').getContext('2d'),{
      type:'line',data:seriesData,
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:false}}}
    });

    function pushChartPoint(avgT,avgPh,avgEc){
      const label = new Date().toLocaleTimeString();
      seriesData.labels.push(label);
      seriesData.datasets[0].data.push(+avgT.toFixed(2));
      seriesData.datasets[1].data.push(+avgPh.toFixed(2));
      seriesData.datasets[2].data.push(+avgEc.toFixed(2));
      if(seriesData.labels.length>60){ // ساعة من النقاط إذا كانت كل دقيقة
        seriesData.labels.shift();
        seriesData.datasets.forEach(d=>d.data.shift());
      }
      seriesChart.update();
    }

    // ================= دورة التحديث الدقيقة =================
    const lastReadingMap = new Map(); // id -> last reading
    function minuteTick(){
      // 1) حدّث موقع كل عوامة
      BUOYS.forEach(b => driftPosition(b));

      // 2) كوّن قراءة جديدة لكل عوامة
      const now = new Date();
      const ts = now.toLocaleString();
      const readings = BUOYS.map(b=>{
        const r = synthReading(lastReadingMap.get(b.id));
        lastReadingMap.set(b.id, r);
        appendEventRow(ts, b.id, r);
        return { id:b.id, lat:b.lat, lon:b.lon, ...r };
      });

      // 3) احسب المتوسطات للكروت والـChart
      const avg = (arr, key)=> arr.reduce((a,x)=>a+x[key],0)/arr.length;
      const avgT = avg(readings, 'turbidity');
      const avgPh= avg(readings, 'ph');
      const avgEc= avg(readings, 'ec');
      $('#avgTurb').textContent = avgT.toFixed(2);
      $('#avgPh').textContent   = avgPh.toFixed(2);
      $('#avgEc').textContent   = avgEc.toFixed(2);

      // 4) الحالة العامة + تحديث الخريطة
      updateGlobalState(readings);
      const mapForRender = new Map(); readings.forEach(r=>mapForRender.set(r.id, r));
      renderBuoys(mapForRender);

      // 5) أضف نقطة للـChart
      pushChartPoint(avgT, avgPh, avgEc);
    }

    // أول تعبئة للجدول بنقطة ابتدائية
    (function initialFill(){
      minuteTick();
    })();

    // شغّل التحديث كل دقيقة
    setInterval(minuteTick, UPDATE_MS);

    // ================= تحذير مرّة كل ساعة =================
    function hourlyAlert(){
      // اختر عوامة عشوائياً واجعل قراءتها تتحول إلى ALERT لحظيًا
      const pick = BUOYS[Math.floor(Math.random()*BUOYS.length)];
      const now = new Date().toLocaleString();
      const forced = { turbidity: +(11 + Math.random()*3).toFixed(2),
                       ph: +(8.9 + Math.random()*0.4).toFixed(2),
                       ec: +(41 + Math.random()*2).toFixed(2),
                       status:"ALERT" };
      lastReadingMap.set(pick.id, forced);
      appendEventRow(now, pick.id, forced);
      renderBuoys(new Map([[pick.id, forced]])); // تحديث اللون فورًا
      updateGlobalState([forced]); // يعكس الحالة العامة إذا لزم

      showToast(`⚠️ تحذير: العوامة ${pick.id} سجّلت مؤشرات خطر (مرّة/ساعة)`, 5000);
    }
    // شغّل التحذير كل ساعة
    setInterval(hourlyAlert, HOURLY_ALERT_MS);

    // ================= الوضع الليلي والتنقل =================
    $('#themeToggle').onclick=()=>document.body.classList.toggle('dark');
    document.querySelectorAll('.nav a').forEach(a=>a.onclick=e=>{
      e.preventDefault();
      document.querySelectorAll('section.page').forEach(p=>p.classList.remove('active'));
      $('#'+a.dataset.target).classList.add('active');
      document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active')); a.classList.add('active');
    });
  </script>
</body>
</html>
